!function(e){"use strict";var t,r,n={},o={},a=0,s=function(e){var t,r=e.replace(/^.\//,"");if(t=o[r],!t){for(var s="",i=0;a>i;i++)s+=". ";var l=n[r];l&&100>a&&(n[r]=null,o[r]={exports:{}},++a,l(o[r]),--a,o[r]=o[r].exports),t=o[r]}return t};n.EventEmitter=function(e){function t(){}e.exports;e.exports=t,t.prototype.addListener=function(e,t){if("function"!=typeof t)throw TypeError("listener must be a function");if(!this.__events)return Object.defineProperty(this,"__events",{value:{},enumerable:!1,writable:!0}),this.__events[e]=[t],this;var r=this.__events[e];return void 0===r?(this.__events[e]=[t],this):(r.push(t),this)},t.prototype.on=t.prototype.addListener,t.prototype.once=function(e,t){var r=!1,n=function(){this.removeListener(e,n),r||(r=!0,t.apply(this,arguments))};return this.on(e,n)},t.prototype.removeListener=function(e,t){var r,n=this.__events?this.__events[e]:void 0;if(void 0!==n){for(;-1!==(r=n.indexOf(t));)n.splice(r,1);return 0===n.length&&delete this.__events[e],n.length}return this},t.prototype.removeAllListeners=function(e){this.__events&&(e?delete this.__events[e]:delete this.__events)},t.prototype.listeners=function(e){return e?this.__events?this.__events[e]:void 0:this.__events},t.prototype.emit=function(e){var t=this.__events?this.__events[e]:void 0;if(void 0===t)return!1;for(var r=0,n=t.length,o=Array.prototype.slice.call(arguments,1);r!==n;++r)t[r]||console.log("e",e,r,o),t[r].apply(this,o);return!0},t.mixin=function(e){for(var r=e;r;){if(r.__proto__===Object.prototype)return r.__proto__=t.prototype,e;r=r.__proto__}return e}},n.buf=function(e){{var t;e.exports}if("undefined"!=typeof Uint8Array){var r=s("./utf8");Uint8Array.prototype.toString=function(e,t,n){return r.decode(this,t,n)},Uint8Array.prototype.slice=Uint8Array.prototype.subarray,Uint8Array.prototype.copy=function(e,t,r,n){var o=this;r&&(o=o.slice(r,n||o.length-r)),e.set(o,t||0)},t=function(e){return e instanceof Uint8Array?e:new Uint8Array(e instanceof ArrayBuffer?e:new ArrayBuffer(e))},t.isBuf=function(e){return e instanceof Uint8Array},t.fromString=function(e){return r.encode(e,t)}}e.exports=t},n.keepalive=function(e){var t=(e.exports,s("./netaccess")),r=s("./protocol"),n=function(e,n,o,a){o?100>o&&(o=100):o=500,(!a||o>a)&&(a=5e3);var s,i,l,u,c,d=0;return s={isEnabled:!1,isConnected:!1,enable:function(){s.enabled||(s.enabled=!0,d=0,s.isConnected||i())},disable:function(){s.enabled&&(clearTimeout(u),s.enabled=!1,d=0)}},i=function(){clearTimeout(u),e.open(n,function(t){c=new Date,t?l(t):(d=0,s.isConnected=!0,e.once("close",l))})},l=function(e){if(clearTimeout(u),s.isConnected=!1,s.enabled){if(t.available&&!t.onLine&&("undefined"==typeof document||!document.location||"localhost"===document.location.hostname||"127.0.0.1"===document.location.hostname||"[::1]"===document.location.hostname))return t.once("online",l),void(d=0);d=e?e.isGotalkProtocolError?e.code===r.ErrorTimeout?0:a:d?Math.min(a,2*d):o:Math.max(0,o-(new Date-c)),u=setTimeout(i,d)}},s};e.exports=n},n.netaccess=function(t){var r,n=(t.exports,s("./EventEmitter"));"undefined"!=typeof e&&e.addEventListener?(r=Object.create(n.prototype,{available:{value:!0,enumerable:!0},onLine:{value:!0,enumerable:!0,writable:!0}}),"undefined"!=typeof navigator&&(r.onLine=navigator.onLine),e.addEventListener("offline",function(){r.onLine=!1,r.emit("offline")}),e.addEventListener("online",function(){r.onLine=!0,r.emit("online")})):r={available:!1,onLine:!0},t.exports=r},n.protocol=function(e){function t(e,t,r,n){for(var o,a=t||0,s=0,i=r.toString(16),l=n-i.length;l--;)e[a++]=48;for(;!isNaN(o=i.charCodeAt(s++));)e[a++]=o}function r(e,r){var n=a(r);return t(n,0,e,r),n}function n(e,t){var r=e.toString(16);return h.substr(0,t-r.length)+r}var o=e.exports,a=s("./buf"),i=s("./utf8");o.Version=1;var l=o.MsgTypeSingleReq="r".charCodeAt(0),u=o.MsgTypeStreamReq="s".charCodeAt(0),c=(o.MsgTypeStreamReqPart="p".charCodeAt(0),o.MsgTypeSingleRes="R".charCodeAt(0),o.MsgTypeStreamRes="S".charCodeAt(0),o.MsgTypeErrorRes="E".charCodeAt(0),o.MsgTypeRetryRes="e".charCodeAt(0)),d=o.MsgTypeNotification="n".charCodeAt(0),f=o.MsgTypeHeartbeat="h".charCodeAt(0),p=o.MsgTypeProtocolError="f".charCodeAt(0);o.ErrorAbnormal=0,o.ErrorUnsupported=1,o.ErrorInvalidMsg=2,o.ErrorTimeout=3,o.HeartbeatMsgMaxLoad=65535,o.binary={makeFixnum:r,versionBuf:r(o.Version,2),parseVersion:function(e){return parseInt(e,16)},parseMsg:function(e){var t,r,n,o,a,s=0,i=0;return t=e[0],a=1,t===f?(s=parseInt(e.slice(a,a+4),16),a+=4):t!==d&&t!==p&&(r=e.slice(a,a+4),a+=4),t==l||t==u||t==d?(o=parseInt(e.slice(a,a+3),16),a+=3,n=e.slice(a,a+o).toString(),a+=o):t===c&&(s=parseInt(e.slice(a,a+8),16),a+=8),i=parseInt(e.slice(a,a+8),16),{t:t,id:r,name:n,wait:s,size:i}},makeMsg:function(e,r,n,o,s){var i,l,u=r?13:9;return n&&0!==n.length&&(l=a.fromString(n),u+=3+l.length),i=a(u),i[0]=e,u=1,r&&4===r.length&&("string"==typeof r?(i[1]=r.charCodeAt(0),i[2]=r.charCodeAt(1),i[3]=r.charCodeAt(2),i[4]=r.charCodeAt(3)):(i[1]=r[0],i[2]=r[1],i[3]=r[2],i[4]=r[3]),u+=4),n&&0!==n.length&&(l=a.fromString(n),t(i,u,l.length,3),u+=3,l.copy(i,u),u+=l.length),e===c&&(t(i,u,o,8),u+=8),t(i,u,s,8),i},makeHeartbeatMsg:function(e){var r=a(13),n=1;return r[0]=f,t(r,n,e,4),n+=4,t(r,n,Math.round((new Date).getTime()/1e3),8),n+=8,r}};var h="00000000";o.text={makeFixnum:n,versionBuf:n(o.Version,2),parseVersion:function(e){return parseInt(e.substr(0,2),16)},parseMsg:function(e){var t,r,n,o,a=0,s=0;return t=e.charCodeAt(0),o=1,t===f?(a=parseInt(e.substr(o,4),16),o+=4):t!==d&&t!==p&&(r=e.substr(o,4),o+=4),t==l||t==u||t==d?n=e.substring(o+3,e.length-8):t==c&&(a=parseInt(e.substr(o,8),16),o+=8),s=parseInt(e.substr(e.length-8),16),{t:t,id:r,name:n,wait:a,size:s}},makeMsg:function(e,t,r,o,a){var s=String.fromCharCode(e);return t&&4===t.length&&(s+=t),r&&0!==r.length&&(s+=n(i.sizeOf(r),3),s+=r),e===c&&(s+=n(o,8)),s+=n(a,8)},makeHeartbeatMsg:function(e){var t=String.fromCharCode(f);return t+=n(e,4),t+=n(Math.round((new Date).getTime()/1e3),8)}}},n.utf8=function(e){function t(e){for(var t,r=0,n=0;t=e.charCodeAt(n++);r+=t>>11?3:t>>7?2:1);return r}function r(e){return 255&e}var n=e.exports;if(n.sizeOf=t,"undefined"!=typeof TextDecoder){var o=new TextDecoder("utf8"),a=new TextEncoder("utf8");n.decode=function(e,t,r){return(t||r)&&(t||(t=0),e=e.slice(t,r||e.length-t)),o.decode(e)},n.encode=function(e,t){return t(a.encode(e))}}else n.decode=function(e,t,n){var o,a,s=t||0,i=n||e.length-s,l="";for(s=0;i>s;)o=e[s++],a=r(o),128>a||(a>>5==6?o=(o<<6&2047)+(63&e[s++]):a>>4==14?(o=(o<<12&65535)+(r(e[s++])<<6&4095),o+=63&e[s++]):a>>3==30&&(o=(o<<18&2097151)+(r(e[s++])<<12&262143),o+=r(e[s++])<<6&4095,o+=63&e[s++])),l+=String.fromCharCode(o);return l},n.encode=function(e,r){for(var n,o=0,a=e.length,s=0,i=r(t(e));o!==a;)n=e.charCodeAt(o++),128>n?i[s++]=n:2048>n?(i[s++]=n>>6|192,i[s++]=63&n|128):65536>n?(i[s++]=n>>12|224,i[s++]=n>>6&63|128,i[s++]=63&n|128):(i[s++]=n>>18|240,i[s++]=n>>12&63|128,i[s++]=n>>6&63|128,i[s++]=63&n|128);return i}},t=function(t){function r(e){try{return JSON.parse(e)}catch(e){}}function n(e){return Object.create(n.prototype,{handlers:{value:e,enumerable:!0},protocol:{value:p?c.binary:c.text,enumerable:!0,writable:!0},heartbeatInterval:{value:2e4,enumerable:!0,writable:!0},ws:{value:null,writable:!0},keepalive:{value:null,writable:!0},nextOpID:{value:0,writable:!0},nextStreamID:{value:0,writable:!0},pendingRes:{value:{},writable:!0},hasPendingRes:{get:function(){for(var e in this.pendingRes)return!0}},pendingClose:{value:!1,writable:!0}})}function o(e,t){if(e.pendingClose=!1,e.stopSendingHeartbeats(),e.ws&&(e.ws.onmessage=null,e.ws.onerror=null,e.ws.onclose=null,e.ws=null),e.nextOpID=0,e.hasPendingRes){var r=t||new Error("connection closed");for(var n in e.pendingRes)e.pendingRes[n](r);e.pendingRes={}}}function a(e,t){var r="string"==typeof e.id?e.id:e.id.toString(),n=this,o=n.pendingRes[r];e.t===c.MsgTypeStreamRes&&t&&0!==(t.length||t.size)||(delete n.pendingRes[r],n.pendingClose&&!n.hasPendingRes&&n.end()),"function"==typeof o&&(e.t===c.MsgTypeErrorRes?o(new Error(String(t)),null):o(null,t))}function i(){return Object.create(i.prototype,{reqHandlers:{value:{}},reqFallbackHandler:{value:null,writable:!0},noteHandlers:{value:{}},noteFallbackHandler:{value:null,writable:!0}})}function l(e,t,r){var n;try{n=new WebSocket(t),n.binaryType="arraybuffer",n.onclose=function(){var e=new Error("connection failed");r&&r(e)},n.onopen=function(){n.onerror=void 0,e.adoptWebSocket(n),e.handshake(),r&&r(null,e),e.emit("open"),e.startReading()},n.onmessage=function(e){n._bufferedMessages||(n._bufferedMessages=[]),n._bufferedMessages.push(e.data)}}catch(t){r&&r(t),e.emit("close",t)}}var u=t.exports,c=s("./protocol"),d=c.text,f=c.binary,p=s("./buf"),h=s("./utf8"),g=s("./EventEmitter"),v=s("./keepalive"),y=u;y.protocol=c,y.Buf=p,n.prototype=g.mixin(n.prototype),u.Sock=n;var b={1e3:"normal",1001:"going away",1002:"protocol error",1003:"unsupported",1005:"no status",1006:"abnormal",1007:"inconsistent",1008:"invalid message",1009:"too large"};n.prototype.adoptWebSocket=function(e){var t=this;if(e.readyState!==WebSocket.OPEN)throw new Error("web socket readyState != OPEN");e.binaryType="arraybuffer",t.ws=e,e.onclose=function(r){var n=e._gotalkCloseError;n||1e3===r.code||(n=new Error("websocket closed: "+(b[r.code]||"#"+r.code))),o(t,n),t.emit("close",n)},e.onmessage=function(t){e._bufferedMessages||(e._bufferedMessages=[]),e._bufferedMessages.push(t.data)}},n.prototype.adopt=function(e){if(adopt instanceof WebSocket)return this.adoptWebSocket(e);throw new Error("unsupported transport")},n.prototype.handshake=function(){this.ws.send(this.protocol.versionBuf)},n.prototype.end=function(){var e=this;e.keepalive&&(e.keepalive.disable(),e.keepalive=null),!e.pendingClose&&e.hasPendingRes?e.pendingClose=!0:e.ws&&e.ws.close(1e3)},n.prototype.address=function(){var e=this;return e.ws?e.ws.url:null};var m=u.ErrAbnormal=Error("unsupported protocol");m.isGotalkProtocolError=!0,m.code=c.ErrorAbnormal;var w=u.ErrUnsupported=Error("unsupported protocol");w.isGotalkProtocolError=!0,w.code=c.ErrorUnsupported;var M=u.ErrInvalidMsg=Error("invalid protocol message");M.isGotalkProtocolError=!0,M.code=c.ErrorInvalidMsg;var E=u.ErrTimeout=Error("timeout");E.isGotalkProtocolError=!0,E.code=c.ErrorTimeout,n.prototype.sendHeartbeat=function(e){var t=this,r=t.protocol.makeHeartbeatMsg(Math.round(e*c.HeartbeatMsgMaxLoad));try{t.ws.send(r)}catch(e){throw(!this.ws||this.ws.readyState>WebSocket.OPEN)&&(e=new Error("socket is closed")),e}},n.prototype.startSendingHeartbeats=function(){var e=this;if(e.heartbeatInterval<10)throw new Error("Sock.heartbeatInterval is too low");clearTimeout(e._sendHeartbeatsTimer);var t=function(){clearTimeout(e._sendHeartbeatsTimer),e.sendHeartbeat(0),e._sendHeartbeatsTimer=setTimeout(t,e.heartbeatInterval)};e._sendHeartbeatsTimer=setTimeout(t,1)},n.prototype.stopSendingHeartbeats=function(){var e=this;clearTimeout(e._sendHeartbeatsTimer)},n.prototype.startReading=function(){function e(e){if(n="string"==typeof e.data?d.parseMsg(e.data):f.parseMsg(p(e.data)),n.t===c.MsgTypeProtocolError){var r=n.size;a._gotalkCloseError=r===c.ErrorAbnormal?m:r===c.ErrorUnsupported?w:r===c.ErrorTimeout?E:M,a.close(4e3+r)}else 0!==n.size&&n.t!==c.MsgTypeHeartbeat?a.onmessage=t:(o.handleMsg(n),n=null)}function t(t){var r=t.data;a.onmessage=e,o.handleMsg(n,"string"==typeof r?r:p(r)),n=null}function r(t){var r="string"==typeof t.data?d.parseVersion(t.data):f.parseVersion(p(t.data));r!==c.Version?(a._gotalkCloseError=w,o.closeError(c.ErrorUnsupported)):(a.onmessage=e,o.heartbeatInterval>0&&o.startSendingHeartbeats())}var n,o=this,a=o.ws;a.onmessage=r,a._bufferedMessages&&(a._bufferedMessages.forEach(function(e){a.onmessage({data:e})}),a._bufferedMessages=null)};var _={};n.prototype.handleMsg=function(e,t){var r=this,n=_[e.t];n?n.call(r,e,t):(r.ws&&(r.ws._gotalkCloseError=M),r.closeError(c.ErrorInvalidMsg))},_[c.MsgTypeSingleReq]=function(e,t){var r,n,o=this;if(r=o.handlers.findRequestHandler(e.name),n=function(t){o.sendMsg(c.MsgTypeSingleRes,e.id,null,0,t)},n.error=function(t){var r=t.message||String(t);o.sendMsg(c.MsgTypeErrorRes,e.id,null,0,r)},"function"!=typeof r)n.error('no such operation "'+e.name+'"');else try{r(t,n,e.name)}catch(e){"undefined"!=typeof console&&console.error(e.stack||e),n.error("internal error")}},_[c.MsgTypeSingleRes]=a,_[c.MsgTypeStreamRes]=a,_[c.MsgTypeErrorRes]=a,_[c.MsgTypeNotification]=function(e,t){var r=this.handlers.findNotificationHandler(e.name);r&&r(t,e.name)},_[c.MsgTypeHeartbeat]=function(e){this.emit("heartbeat",{time:new Date(1e3*e.size),load:e.wait})},n.prototype.sendMsg=function(e,t,r,n,o){var a=o&&"string"==typeof o&&this.protocol===c.binary?h.sizeOf(o):o?o.length||o.size:0,s=this,i=s.protocol.makeMsg(e,t,r,n,a);try{s.ws.send(i),0!==a&&s.ws.send(o)}catch(e){throw(!this.ws||this.ws.readyState>WebSocket.OPEN)&&(e=new Error("socket is closed")),e}},n.prototype.closeError=function(e){var t=this;if(t.ws){try{t.ws.send(t.protocol.makeMsg(c.MsgTypeProtocolError,null,null,0,e))}catch(e){}t.ws.close(4e3+e)}};var k="0000";n.prototype.bufferRequest=function(e,t,r){var n=this,o=n.nextOpID++;1679616===n.nextOpID&&(n.nextOpID=0),o=o.toString(36),o=k.substr(0,4-o.length)+o,n.pendingRes[o]=r;try{n.sendMsg(c.MsgTypeSingleReq,o,e,0,t)}catch(e){delete n.pendingRes[o],r(e)}},n.prototype.bufferNotify=function(e,t){this.sendMsg(c.MsgTypeNotification,null,e,0,t)},n.prototype.request=function(e,t,n){var o;return n?o=JSON.stringify(t):n=t,this.bufferRequest(e,o,function(e,t){var o=r(t);return n(e,o)})},n.prototype.notify=function(e,t){var r=JSON.stringify(t);return this.bufferNotify(e,r)};var S=function(e,t,r){return Object.create(S.prototype,{s:{value:e},op:{value:t,enumerable:!0},id:{value:r,enumerable:!0}})};if(g.mixin(S.prototype),S.prototype.write=function(e){this.ended||(this.started?this.s.sendMsg(c.MsgTypeStreamReqPart,this.id,null,0,e):(this.started=!0,this.s.sendMsg(c.MsgTypeStreamReq,this.id,this.op,0,e)),e&&0!==e.length&&0!==e.size||(this.ended=!0))},S.prototype.end=function(){this.write(null)},n.prototype.streamRequest=function(e){var t=this,r=t.nextStreamID++;46656===t.nextStreamID&&(t.nextStreamID=0),r=r.toString(36),r="!"+k.substr(0,3-r.length)+r;var n=S(t,e,r);return t.pendingRes[r]=function(e,t){e?n.emit("end",e):t&&0!==t.length?n.emit("data",t):n.emit("end",null)},n},u.Handlers=i,i.prototype.handleBufferRequest=function(e,t){e?this.reqHandlers[e]=t:this.reqFallbackHandler=t},i.prototype.handleRequest=function(e,t){return this.handleBufferRequest(e,function(e,n,o){var a=function(e){return n(JSON.stringify(e))};a.error=n.error;var s=r(e);t(s,a,o)})},i.prototype.handleBufferNotification=function(e,t){e?this.noteHandlers[e]=t:this.noteFallbackHandler=t},i.prototype.handleNotification=function(e,t){this.handleBufferNotification(e,function(e,n){t(r(e),n)})},i.prototype.findRequestHandler=function(e){var t=this.reqHandlers[e];return t||this.reqFallbackHandler},i.prototype.findNotificationHandler=function(e){var t=this.noteHandlers[e];return t||this.noteFallbackHandler},void 0!==e.gotalkResponderAt){var T=e.gotalkResponderAt;T&&T.ws&&(y.defaultResponderAddress=("https:"==document.location.protocol?"wss://":"ws://")+document.location.host+T.ws),delete e.gotalkResponderAt}n.prototype.open=function(e,t){var r=this;if(t||"function"!=typeof e||(t=e,e=null),!e){if(!y.defaultResponderAddress)throw new Error("address not specified (responder has not announced any default address)");e=y.defaultResponderAddress}return l(r,e,t),r},y.open=function(e,t){return n(y.defaultHandlers).open(e,t)},n.prototype.openKeepAlive=function(e){var t=this;return t.keepalive&&t.keepalive.disable(),t.keepalive=v(t,e),t.keepalive.enable(),t},y.connection=function(e){return n(y.defaultHandlers).openKeepAlive(e)},y.defaultHandlers=i(),y.handleBufferRequest=function(e,t){return y.defaultHandlers.handleBufferRequest(e,t)},y.handle=function(e,t){return y.defaultHandlers.handleRequest(e,t)},y.handleBufferNotification=function(e,t){return y.defaultHandlers.handleBufferNotification(e,t)},y.handleNotification=function(e,t){return y.defaultHandlers.handleNotification(e,t)}},r={exports:{}},t(r),e.gotalk=r.exports}(this);
//# sourceMappingURL=gotalk.js.map